/**
 * ||GEISSWEB| EU VAT Enhanced
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the GEISSWEB End User License Agreement
 * that is available through the world-wide-web at this URL: https://www.geissweb.de/legal-information/eula
 *
 * DISCLAIMER
 *
 * Do not edit this file if you wish to update the extension in the future. If you wish to customize the extension
 * for your needs please refer to our support for more information.
 *
 * @copyright   Copyright (c) 2015 GEISS WeblÃ¶sungen (https://www.geissweb.de)
 * @license     https://www.geissweb.de/legal-information/eula GEISSWEB End User License Agreement
 */

define([
    'jquery',
    'Geissweb_Euvat/js/form/element/vat-number-co',
    'Geissweb_Euvat/js/queue',
    'uiRegistry',
    'mageUtils',
    'mage/translate',
    'Magento_Ui/js/lib/validation/validator',
    'Magento_Ui/js/modal/confirm',
    'Magento_Ui/js/model/messageList',
    'Magento_Checkout/js/checkout-data',
    'Magento_Checkout/js/model/quote',

    'Magento_Checkout/js/action/select-payment-method',
    'Magento_Checkout/js/model/payment-service',

    'Magento_Customer/js/customer-data',
    'Aheadworks_OneStepCheckout/js/action/set-shipping-information',
    'Aheadworks_OneStepCheckout/js/model/totals-service'
], function (
    $,
    VatNumberCo,
    queue,
    registry,
    Utils,
    $t,
    validator,
    confirm,
    messages,
    CheckoutData,
    Quote,

    MagentoSelectPaymentMethod,
    MagentoPaymentService,

    CustomerData,

    AWSetShippingInformation,
    AWTotalsService
) {
    'use strict';

    return VatNumberCo.extend({

        defaults: {
            debug: false
        },

        initialize: function () {
            this.element = this._super();
            this.initObservable().setCssClasses();
            var self = this;

            if (this.customScope === 'shippingAddress') {
                this.countrySelect = registry.get('checkout.shippingAddress.shipping-address-fieldset.included-country-field-row.country_id');
            } else {
                this.countrySelect = registry.get('checkout.paymentMethod.billingAddress.billing-address-fieldset.included-country-field-row.country_id');
            }

            return this;
        },

        afterValidation: function (jqXHR) {
            if (this.debug) {
                console.log("aw afterValidation");
            }
            var self = this;

            if (this.countryCode.length > 0) {
                queue.addFunction(function () {
                    return self.updateCountry(self.countryCode, jqXHR);
                })
            }

            if (this.customScope === 'shippingAddress') {
                queue.addFunction(function () {
                    AWTotalsService.isLoading(true);
                    AWSetShippingInformation()
                    .success(function (response) {
                        Quote.setTotals(response.totals);
                    }).always(function () {
                        $('body').trigger('processStop');
                        AWTotalsService.isLoading(false);
                    });
                });
            }

            queue.addFunction(function () {
                $('body').trigger('processStop');
            });

            return queue.run();
        },

        /**
         * Get country value from select
         * @returns {string}
         */
        getCountry: function () {
            if (typeof(this.countrySelect) !== 'object' || Utils.isEmpty(this.countrySelect.value())) {
                return '';
            }
            if (this.debug) {
                console.log("aw getCountry: "+this.countrySelect.value(), this.countrySelect);
            }
            return this.countrySelect.value();
        },

        /**
         * Set country value for select
         * @param value
         * @returns {boolean}
         */
        setCountry: function (value) {
            if (typeof(this.countrySelect) !== 'object' || Utils.isEmpty(value)) {
                return false;
            }
            if (this.debug) {
                console.log("aw setCountry: "+value);
            }
            this.countrySelect.value(value);
            return true;
        },

        /**
         * @param {String} value
         * @param deferred
         */
        updateCountry: function (value, deferred) {
            var country = this.getCountry();
            if (this.debug) {
                console.log("aw updateCountry()");
                console.log("value:"+value);
                console.log("country:"+country);
            }

            if (!value
                || !this.askCustomerCountryCorrection
                || Utils.isEmpty(country)
                || $.inArray(value, this.euCountries) === -1
            ) {
                if (this.debug) {
                    console.log("updateCountry abort!", {
                        "value": value,
                        "country": country,
                        "askCustomerCountryCorrection": this.askCustomerCountryCorrection,
                        "isEmpty": Utils.isEmpty(country),
                        "inEuCountries": $.inArray(value, this.euCountries)
                    });
                }
                return deferred.promise();
            }

            if (value === 'EL') {
                value = 'GR';
            }

            if (value !== country) {
                var self = this;
                confirm({
                    title: $t('VAT number validation result'),
                    content: $t('The country prefix of your VAT Number does not match your address country. Shall we automatically set the country?'),
                    actions: {
                        confirm: function () {
                            self.setCountry(value);
                        },
                        cancel: function () {
                            self.countryCode = '';
                            self.value('');
                            self.clearMessages();
                        },
                        always: function () {
                            $('body').trigger('processStop');
                        }
                    }
                });
            }

        }

    });
});
